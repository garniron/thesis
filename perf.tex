\documentclass[./thesis.tex]{subfiles}

In this chapter, we discuss the efficiency of the implementation. The system
we chose for these numerical experiments is a cyanine dye,
[(NH$_2$)(CH)(NH$_2$)]$^+$ in its ground state and in its first excited state.
The geometry is the equilibrium geometry of the ground state, optimized at the
PBE0/cc-pVQZ level. The ground state is a closed shell, well described by a
single reference, and the excited state is singly excited and requires two
determinants in the reference ($1/\sqrt{2} (a\bar{b} + b\bar{a})$).  The
calculations were performed in the aug-cc-pVDZ basis set with state-averaged
natural orbitals obtained from an initial CIPSI calculation.
The $1s$ orbitals of the carbon and the nitrogen atoms were frozen, so
the FCI space which is explored is a CAS(18,111). The reference excitation
energy, obtained at the CC3/ANO-L-VQZP level is 7.18~eV\cite{Send_2011}.
The measurements were made on the Olympe supercomputer (CALMIP). Each node is 
a dual-socket Intel(R) Xeon(R) Gold 6140 CPU @ 2.30GHz with 192GiB of RAM, and
contains 36 physical CPU cores.

\begin{figure}[h]
	\begin{center}
		\includegraphics[width=0.8\columnwidth]{figures/perf/cn3_energy}
		\caption{Convergence of the energy of the ground and excited states with respect to the number of determinants in the variational space.}
		\label{fig:energy_pt2}
	\end{center}
\end{figure}

\begin{table}
\caption{Energies and second-order perturbative corrections for increasingly large wave functions. $\Delta$ is the energy difference
between the ground state and the excited state.}
\label{tab:energy_pt2}
\begin{center}
\begin{tabular}{rllrr}
\hline
\tabc{$\Ndet$} & \tabc{Ground state} & \tabc{Excited state} & \tabc{$\Delta E$ (eV)} \\
\hline
\multicolumn{4}{c}{$\Evar$}  \\
$        7$ & $-149.489~186$ & $-149.207~354$ & $7.67$  \\
$      123$ & $-149.536~265$ & $-149.261~860$ & $7.47$  \\
$    3~083$ & $-149.685~606$ & $-149.404~450$ & $7.65$  \\
$   29~409$ & $-149.826~151$ & $-149.547~275$ & $7.59$  \\
$  168~595$ & $-149.900~352$ & $-149.626~058$ & $7.46$  \\
$1~322~537$ & $-149.946~655$ & $-149.675~032$ & $7.39$  \\
$8~495~334$ & $-149.972~032$ & $-149.704~145$ & $7.29$  \\
$9~356~952$ & $-149.973~375$ & $-149.706~822$ & $7.25$  \\
\hline
\multicolumn{4}{c}{$\Evar + \EPT$}  \\
$        7$ &  $-150.161~107  $ &  $-149.904~883  $ & $6.97$ \\
$      123$ &  $-150.116~958  $ &  $-149.849~465  $ & $7.28$ \\
$    3~083$ &  $-150.043~5(2) $ &  $-149.780~8(2) $ & $7.15$ \\
$   29~409$ &  $-150.022~2(2) $ &  $-149.758~3(2) $ & $7.18$ \\
$  168~595$ &  $-150.019~9(1) $ &  $-149.754~5(1) $ & $7.22$ \\
$1~322~537$ &  $-150.017~89(7)$ &  $-149.752~55(7)$ & $7.22$ \\
$8~495~334$ &  $-150.015~97(4)$ &  $-149.750~87(5)$ & $7.21$ \\
$9~356~952$ &  $-150.015~95(4)$ &  $-149.750~68(4)$ & $7.22$ \\
\hline
\end{tabular}
\end{center}
\end{table}

In figure~\ref{fig:energy_pt2}, we plot the convergence of the energies of
the ground and excited states as a function of the number of
determinants, with and without the second order perturbative contribution.

\section{Davidson diagonalization}

\begin{table}[t]
\caption{Time (in seconds) to run one Davidson's iteration in parallel on the largest wave function
with an increasing number of 36-core compute nodes.}
\label{tab:time_davidson}
\begin{center}
\begin{tabular}{rr}
\hline
\tabc{Nodes} & \tabc{Wall-clock time (s)} \\
\hline
$ 1$ &$12~361.68$ \\
$ 5$ &$ 2~580.70$ \\
$10$ &$ 1~363.24$ \\
$20$ &$   746.36$ \\
$30$ &$   542.91$ \\
$40$ &$   442.11$ \\
$50$ &$   381.92$ \\
\hline
\end{tabular}
\end{center}
\end{table}

\begin{figure}[h]
	\begin{center}
		\includegraphics[width=0.8\columnwidth]{figures/perf/speedup_davidson}
		\caption{Speedup of one Davidson iteration as a function of the number of 36-core
compute nodes.}
		\label{fig:speedup_davidson}
	\end{center}
\end{figure}

We took a wavefunction with 42~959~496 determinants, and measured the wall-clock time required to
perform one iteration of the Davidson diagonalization, with an increasing number of compute nodes.
The timings are reported in table~\ref{tab:time_davidson} and the parallel speedup curve is represented in figure~\ref{fig:speedup_davidson}.


\section{Selection}


\section{PT2 calculations}

The stopping criterion of the calculation of the PT2 contribution was a
relative statistical error below 1/1000-th.
The fraction of the full deterministic calculation required to reach this criterion
is typically around $5\%$.

\begin{figure}[h]
	\begin{center}
		\includegraphics[width=0.8\columnwidth]{figures/perf/scaling_pt2_det}
		\caption{Wall clock time required to compute the PT2 contribution for the ground and the excited states, as a function of the number of determinants in the wave function.}
		\label{fig:scaling_det_pt2}
	\end{center}
\end{figure}

\begin{table}
\caption{Single-node (36-core) $\EPT$ calculations for increasingly large wave functions. Time is given in seconds, and energies are given in atomic units.}
\label{tab:time_pt2}
\begin{center}
\begin{tabular}{rrr}
\hline
\tabc{$\Ndet$} & \tabc{Ground state} & \tabc{Excited state} \\
\hline
$        7$ &  $     0.00$ & $     0.00$ \\
$      123$ &  $     0.48$ & $     0.53$ \\
$    3~083$ &  $     1.53$ & $     2.05$ \\
$   29~409$ &  $    13.71$ & $    23.75$ \\
$  168~595$ &  $   138.17$ & $   155.36$ \\
$1~322~537$ &  $ 2~456.66$ & $ 2~640.67$ \\
$8~495~334$ &  $38~350.47$ & $42~796.15$ \\
$9~356~952$ &  $44~873.53$ & $50~361.70$ \\
\hline
\end{tabular}
\end{center}
\end{table}

\begin{table}
\caption{Time (in seconds) to run parallel $\EPT$ calculations on the largest wave function with an
increasing number of 36-core compute nodes.}
\label{tab:energy_pt2}
\begin{center}
\begin{tabular}{rrr}
\hline
\tabc{Nodes} & \tabc{Ground state} & \tabc{Excited state} \\
\hline
$ 1$ & $44~873.53$ & $50~361.70$ \\
$ 5$ & $10~552.02$ & $11~260.12$ \\
$10$ & $ 5~381.51$ & $ 5~918.34$ \\
$20$ & $ 2~782.87$ & $ 3~043.94$ \\
$30$ & $ 1~884.67$ & $ 2~069.17$ \\
$40$ & $ 1~440.96$ & $ 1~568.30$ \\
$50$ & $ 1~154.97$ & $ 1~273.66$ \\
\hline
\end{tabular}
\end{center}
\end{table}

Table~\ref{tab:time_pt2} reports the wall-clock time required to compute the
PT2 contribution on a single node.

From these data, one can evaluate the scaling of the cost of the PT2 contribution
with the number of determinants, as plotted in figure~\ref{fig:scaling_det_pt2}.
We first remark an $\order{N^2}$-like behavior for small sizes, which is consistent
with the fact that
\begin{enumerate}
\item the number of $\ket{\alpha}$ determinants is proportional to the
number of generators, and 
\item each $\ket{\alpha}$ needs to be compared to all the determinants of the wave function in the computation of $\mel{\alpha}{H}{\Psi}$.
\end{enumerate}
But when the wave function becomes large enough, the second point is not true any more because only a limited number of determinants $\ket{I}$ of $\Psi$ have a non-zero
value $\mel{\alpha}{H}{I}$, and this number is bounded by the number of single and double excitations, characteristic of the basis set. This explains the asymptotic linear scaling behavior one can observe.
\begin{figure}[h]
	\begin{center}
		\includegraphics[width=0.8\columnwidth]{figures/perf/scaling_pt2_node}
		\caption{Parallel speedup for the calculation of the $\EPT$ contribution of the ground state using the largest wave function. Each node contains 36 physical CPU cores.}
		\label{fig:scaling_node_pt2}
	\end{center}
\end{figure}

To analyze the parallel efficiency of the $\EPT$ calculation, we have made the parallel speedup curve using up to 48 nodes (1728 CPU cores), plotted in figure~\ref{fig:scaling_node_pt2}. One obtains a speedup of 42.6 with 48 nodes with respect to the single-node reference. This corresponds to a parallel efficiency of 88.7\%.

\section{Shifted-Bk}

\section{Multi-reference Coupled-Cluster}


\end{document}
